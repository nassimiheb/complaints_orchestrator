Customer Complaints Resolution Orchestrator
ASCII Activity Diagrams - Current System (Phase 0 to Phase 5)

====================================================================
1) MAIN CLI FLOW (src/main.py)
====================================================================

 [START]
    |
    v
 [Parse CLI args]
    |
    v
 [Load config from env]
    |
    v
 [Configure logging]
    |
    v
 < --demo-security ? >
    |Yes                             |No
    v                                v
 [Run security demo]            < --scenario provided ? >
    |                                |No                     |Yes
    v                                v                       v
 [Print security outputs]       [Print bootstrap msg]   [Print scenario-not-wired msg]
    |                                |                       |
    +---------------+----------------+-----------------------+
                    |
                    v
                  [EXIT]


====================================================================
2) SECURITY DEMO FLOW (PII + Language + Output Guard)
====================================================================

 [Build sample CaseState]
    |
    v
 [Redact PII in email body]
    |
    v
 < Any PII found ? >
    |Yes                                   |No
    v                                      v
 [Add events: PII_REDACTED + entity]   [Add event: PII_REDACTION_NOT_NEEDED]
    |                                      |
    +------------------+-------------------+
                       |
                       v
              [Detect language from redacted text]
                       |
                       v
        [Choose response language (detected -> memory fallback -> EN default)]
                       |
                       v
               [Draft sample customer email]
                       |
                       v
               [Apply output guard]
                       |
                       v
             < Guard passed initially ? >
                  |Yes                      |No
                  v                         v
       [Event: OUTPUT_GUARD_PASSED]   [Events: OUTPUT_GUARD_FAILED + violations]
                  |                         |
                  |                         v
                  |                 < Sanitization enabled ? >
                  |                      |No                |Yes
                  |                      v                  v
                  |               [Return failed]      [Sanitize email]
                  |                                         |
                  |                                         v
                  |                                < Pass after sanitize ? >
                  |                                   |Yes               |No
                  |                                   v                  v
                  |                 [Events: OUTPUT_GUARD_SANITIZED,   [Event: OUTPUT_GUARD_FALLBACK_REQUIRED]
                  |                  OUTPUT_GUARD_PASSED]
                  |                                   |                  |
                  +--------------------+--------------+------------------+
                                       |
                                       v
                         [Set state.output_guard_passed]
                                       |
                                       v
                   [Print redacted body, language, guard result, events]


====================================================================
3) TOOL REGISTRY FLOW (tools/registry.py::call_tool)
====================================================================

 [call_tool(tool_name, role, payload)]
    |
    v
 < Tool exists in registry ? >
    |No                         |Yes
    v                           v
 [Raise KeyError]       < Role allowed for this tool ? >
                                |No                      |Yes
                                v                        v
                      [Raise ToolPermissionError]   [Validate input schema]
                                                        |
                                                        v
                                                < Input valid ? >
                                                  |No         |Yes
                                                  v           v
                                    [Raise ValidationError] [Execute handler with retry]
                                                                |
                                                                v
                                                        [Validate output schema]
                                                                |
                                                                v
                                                        < Output valid ? >
                                                          |No         |Yes
                                                          v           v
                                            [Raise ValidationError] [Log success + return dict]


====================================================================
4) MEMORY FLOW (memory/store.py::record_finalize_update)
====================================================================

 [record_finalize_update(...)]
    |
    v
 [upsert_case_memory(..., summary_payload)]
    |
    v
 < summary_payload contains raw email keys ? >
    |Yes                            |No
    v                               v
 [Raise ValueError]          [Write/Upsert case row]
                                    |
                                    v
                   [Compute 90-day compensation total from cases_memory]
                                    |
                                    v
                   [upsert_customer_memory(preferred_language, total)]
                                    |
                                    v
                                  [END]


====================================================================
5) RAG INDEX BUILD FLOW (rag/build_index.py::build_index)
====================================================================

 [build_index(docs_dir, chroma_dir, ...)]
    |
    v
 < docs_dir exists ? >
    |No                           |Yes
    v                             v
 [Raise FileNotFoundError]   [Open/Create Chroma collection]
                                   |
                                   v
                         [Iterate files under docs_dir]
                                   |
                                   v
                        < Allowed source + extension ? >
                           |No                       |Yes
                           |                         v
                           |                 [Read file text]
                           |                         |
                           |                         v
                           |                 [Infer metadata]
                           |                         |
                           |                         v
                           |                 [Chunk text]
                           |                         |
                           |                         v
                           |                 < Chunk suspicious ? >
                           |                   |Yes          |No
                           |                   v             v
                           |           [Skip + log]   [Sanitize chunk + cap size]
                           |                                  |
                           |                                  v
                           |                      < Empty or suspicious after sanitize ? >
                           |                         |Yes                      |No
                           |                         v                         v
                           |                  [Skip + maybe log]   [Collect id/doc/metadata]
                           |                                                   |
                           +------------------------- loop --------------------+
                                   |
                                   v
                           < Any collected chunks ? >
                              |No                     |Yes
                              v                       v
                     [Return stats indexed=0]   [Embed + add to Chroma]
                                                      |
                                                      v
                                                 [Return stats]


====================================================================
6) RAG RETRIEVAL FLOW (rag/retriever.py::PolicyRetriever.retrieve)
====================================================================

 [retrieve(query, language, top_k, policy_type?)]
    |
    v
 [Sanitize query]
    |
    v
 < Query empty after sanitize ? >
    |Yes                    |No
    v                       v
 [Return []]         [Embed query]
                           |
                           v
 [Query Chroma where language=..., n_results=max(top_k*3, top_k)]
                           |
                           v
                 [Iterate candidate results]
                           |
                           v
                  < Internal source path ? >
                    |No                  |Yes
                    v                    v
            [Skip + log warning]   < policy_type filter matches ? >
                                      |No                |Yes or not requested
                                      v                  v
                                    [Skip]         [Sanitize snippet]
                                                        |
                                                        v
                                             < Empty or suspicious snippet ? >
                                                 |Yes                  |No
                                                 v                     v
                                           [Skip + log]     [Build structured output item]
                                                                    |
                                                                    v
                                                         < Reached top_k ? >
                                                            |Yes          |No
                                                            v             v
                                                    [Return output]   [Continue loop]


====================================================================
NOTES
====================================================================

 - This reflects implemented behavior up to Phase 5.
 - Graph orchestration nodes (ingest/triage/context/resolution/finalize graph routing)
   are planned for later phases.
 - Security events are persisted in CaseState.security_events and logged.

